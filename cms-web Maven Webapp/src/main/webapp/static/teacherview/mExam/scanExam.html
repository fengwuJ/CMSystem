<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>批改试卷</title>
<link href="../../css/teachersty.css" th:href="@{/static/css/teachersty.css}" rel="stylesheet">
<!-- 引入bootstrap样式 -->
<link href="../../css/bootstrap.min.css" th:href="@{/static/css/bootstrap.min.css}" rel="stylesheet">
<!-- jquery -->
<script src="../../js/jquery.min.js" th:src="@{/static/js/jquery.min.js}"></script>
<script src="../../js/bootstrap.min.js" th:src="@{/static/js/bootstrap.min.js}"></script>
<!-- bootstrap-table.min.js -->
<script src="../../js/bootstrap-table.min.js" th:src="@{/static/js/bootstrap-table.min.js}"></script>
<!-- 引入中文语言包 -->
<script src="../../js/bootstrap-table-zh-CN.min.js" th:src="@{/static/js/bootstrap-table-zh-CN.min.js}"></script>

<!-- li指针样式 -->
<style type="text/css">
	li{
		cursor: pointer;
		color:  #0066cc;
	}
</style>

<script type="text/javascript">
	//绘制表单
	$(function() {
		var tid = $("#uid",parent.document).val();
		var cid = $("#courseid",parent.document).text();
		var sid;
		var examName;
		function getSingleRecord(row){
			$("ol li").removeClass("active");
			var name = "单挑数据"
			var guidEle = $('<li class="active deleteLi">' + name + '</li>');
			$(".breadcrumb").append(guidEle);
			$(".card").html($("#replacediv").html());
			$("#subDiv").show();
			sid = row.sid;
			examName = row.examName;
			$.ajax({
				url : "searchSingleExam", // 请求目标
				type : "GET", // 请求类型 POST(加密) 或者 GET(默认)
				data : {sid : row.sid, examName : row.examName},
				dataType : 'json',
				async : true, // true代表异步 是默认的 false代表同步(浏览器一般不支持同步)
				cache : false, // true代表缓存,缓存后再次加载会快很多 false代表不缓存 
				success : function(data) {
					var totalGoal = data.totalGoal;
					var singleGoal = data.singleGoal;
					var sa = data.saInfo;
					var standardAnswers = data.standardAnswers;
					$("#totalGoal").text(totalGoal);
					$("#singleGoal").text(singleGoal);
					for(var index in standardAnswers){
						if(index == 0){
							$("#sa1").text(standardAnswers[index]);
							$("#a1").text(sa.a1);
						}
						if(index == 1){
							$("#sa2").text(standardAnswers[index]);
							$("#a2").text(sa.a2);
						}
						if(index == 2){
							$("#sa3").text(standardAnswers[index]);
							$("#a3").text(sa.a3);
						}
					}
				}
			});
		}	
	
		function getExamRecords() {
			$("#subDiv").hide();
			$("#table").bootstrapTable('destroy');
			$("#table").bootstrapTable({ // 对应table标签的id
				url : "getStuExamRecord", // 获取表格数据的url
				cache : false, // 设置为 false 禁用 AJAX 数据缓存， 默认为true
				striped : true, //表格显示条纹，默认为false
				pagination : true, // 在表格底部显示分页组件，默认false
				pageList : [ 1, 2 ], // 设置页面可以显示的数据条数
				pageSize : 1, // 页面数据条数
				pageNumber : 1, // 首页页码
				sidePagination : 'server', // 设置为服务器端分页
				queryParams : function(params) { // 请求服务器数据时发送的参数，可以在这里添加额外的查询参数，返回false则终止请求

					return {
						pageSize : params.limit, // 每页要显示的数据条数
						offset : params.offset, // 每页显示数据的开始行号
						sort : params.sort, // 要排序的字段
						sortOrder : params.order, // 排序规则
						tid : tid,
						cid : cid,
					}
				},
				sortName : 'sid', // 要排序的字段
				sortOrder : 'desc', // 排序规则
				columns : [
					{
						field : 'sid', // 返回json数据中的name
						title : '学号', // 表格表头显示文字
						align : 'center', // 左右居中
						valign : 'middle' // 上下居中
					}, {
						field : 'sname',
						title : '姓名',
						align : 'center',
						valign : 'middle'
					}, {
						field : 'examName',
						title : '试卷名称',
						align : 'center',
						valign : 'middle'
					},{
						field : 'time',
						title : '考试时间',
						align : 'center',
						valign : 'middle'
					},{
						title : "操作",
						align : 'center',
						valign : 'middle',
						width : 160, // 定义列的宽度，单位为像素px
						formatter : function(value, row, index) {
							var option;
							if(row.time == null){
								option = '<span>未考试</span>';
							}else if(row.goal == 0){
								option = '<a href="javascript:void(0)"  class="msub">批改</a>';
							}else{
								option = '<span>已批改</span>';
							}
							return option;//批改或查看
						},
						events: operateEvents = {"click .msub":function(e,value,row,index){
					              		getSingleRecord(row);
					         }
					    }  
					}
				],
				onLoadSuccess : function() { //加载成功时执行
					console.info("加载成功");
				},
				onLoadError : function() { //加载失败时执行
					console.info("加载数据失败");
				}
			})
		}


		//作业记录点击事件
		$("#record").on('click', function() {
			$(this).addClass('active');
			$(".deleteLi").remove();
			
			var tableHtml = '<table id="table"></table>';
			$(".card").html(tableHtml);
			getExamRecords();
		});

		$('#submitStuExam').click(function(){
			var reg = /^[0-9]*$/;
			var totalGoal = parseInt($("#totalGoal").text());
			var singleGoal = parseInt($("#singleGoal").text());
			var shortGoal = 0;
			var flag = true;
			$(".msaGoal").each(function(){
				
				if($(this).val() == ""){
					flag = false;
					alert("您的题目未修改完");
				}
				if(!reg.test($(this).val())){
					flag = false;
					alert("只能输入数字");
				}
				if(parseInt($(this).val()) < 0 || parseInt($(this).val()) > 20){
					flag = false;
					alert("单个简答题最高20分，最低0分");
				}
				shortGoal += parseInt($(this).val());
			})
			
			totalGoal = shortGoal + singleGoal;
			if(flag){
				$.ajax({
					url : "updateSAandTotalGoal", // 请求目标
					type : "GET", // 请求类型 POST(加密) 或者 GET(默认)
					data : {sid : sid, examName : examName, tid : tid, cid : cid, shortGoal : shortGoal, totalGoal : totalGoal},
					dataType : 'text',
					async : true, // true代表异步 是默认的 false代表同步(浏览器一般不支持同步)
					cache : false, // true代表缓存,缓存后再次加载会快很多 false代表不缓存 
					success : function(data) {
						alert(data);
						$("#record").click();
					}
				});
			}
			
			
		});

		//初始化表单
		getExamRecords();

	});
</script>

</head>
<body>
	<!-- 测试增加导航条 -->
	<!-- 
	<div style="padding-top: 8px;padding-right: 15px;float: right;">
		<button class="btn btn-info btn-sm" id="test">增加导航条</button>
	</div>	
	-->
	<div style="padding-top: 8px;padding-right: 15px;float: right;" id="subDiv">
		<button class="btn btn-info btn-sm" id="submitStuExam">提交修改</button>
	</div>
	<div class="cmtitle">批改试卷</div>
	<div class="cmline"></div>
	
	<!-- 面包屑导航条 -->
	<ol class="breadcrumb" style="margin-bottom: 0px; padding: 1px 15px;">
		<li id="record" class="active">试卷列表</li>
	</ol>
	
	<div class="card" style="margin-top: 0px;">
		<table id="table">
		</table>
	</div><!-- card结束 -->
	
	<!-- div容器 -->
		<div id="replacediv" style="display: none;">
			<!-- 总得分 -->
			<div class="panel panel-success">
				<div class="panel-heading" style="clear: both;height: 40px;text-align: center;">
					<div style="float: left;">
						总得分
					</div>
					<div style="float: right;">
						得分：<span id="totalGoal"></span>
					</div>
				</div>
			</div>
		
			<!-- 单选题 -->
			<div class="panel panel-info">
				<div class="panel-heading" style="clear: both;height: 40px;text-align: center;">
					<div style="float: left;">
						单选题得分
					</div>
					<div style="float: right;">
						得分：<span id="singleGoal"></span>
					</div>
				</div>
			</div>
			
			<!-- 简答题 -->
			<div class="panel panel-info">
				<div class="panel-heading" style="clear: both;height: 40px;text-align: center;">
					<div style="float: left;">
						简答题得分
					</div>
				</div>	<!-- heading结束 -->
				<div class="panel-body">
					<div style="overflow-y: auto;height: 210px;">
						<div class="container" style="margin-top: 15px;">
						    <div class="row">
						        <div class="col-xs-6 ">
						        	标准答案：<span id="sa1"></span>
						        </div>
						        <div class="col-xs-6 ">
						        	学生答案：<span id="a1"></span>
						        </div>
						    </div>
						    本题得分：<input value="0" class="msaGoal"/>
						</div>
						<div class="container" style="margin-top: 15px;">
						    <div class="row">
						        <div class="col-xs-6 ">
						        	标准答案：<span id="sa2"></span>
						        </div>
						        <div class="col-xs-6 ">
						        	学生答案：<span id="a2"></span>
						        </div>
						    </div>
						    本题得分：<input value="0" class="msaGoal"/>
						</div>
						<div class="container" style="margin-top: 15px;">
						    <div class="row">
						        <div class="col-xs-6 ">
						        	标准答案：<span id="sa3"></span>
						        </div>
						        <div class="col-xs-6 ">
						        	学生答案：<span id="a3"></span>
						        </div>
						    </div>
						    本题得分：<input value="0" class="msaGoal"/>
						</div>
						
					</div>
				</div>	<!-- body结束 -->
			</div>	<!-- info结束 -->
		</div><!-- div容器结束 -->
	
</body>
</html>